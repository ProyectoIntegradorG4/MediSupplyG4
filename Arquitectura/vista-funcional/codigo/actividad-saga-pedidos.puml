@startuml Modelo de Actividades - Sistema MediSupply
skinparam backgroundColor transparent
skinparam activity {
    BackgroundColor #F8F9FA
    BorderColor #6C757D
    FontColor #212529
}
skinparam partition {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    FontColor #0D47A1
}

title Modelo de Actividades: SAGA Pattern
partition "Aplicaci√≥n M√≥vil" {
    start
    :Iniciar Creaci√≥n Pedido;
    note right: **Tiempo l√≠mite**: 30s interfaz
    :Validar Sesi√≥n;
    note right: **Token JWT**: Cach√© local
}

partition "Gateway de API" {
    :Recibir Solicitud;
    note right: **L√≠mite de velocidad**: 100 sol/min
    :Validar Autenticaci√≥n;
    note right: **Interruptor de circuito**: 3 fallos
    :Enrutar Solicitud;
    note right: **Balanceador de carga**: Round Robin
}

partition "Servicio de Pedidos\n(Coordinador SAGA)" {
    :Iniciar Coordinador SAGA;
    note right: **Patr√≥n**: Orquestaci√≥n distribuida
    :Generar ID SAGA;
    note right: **UUID**: Trazabilidad pedido
    :Registrar Evento SAGA_INICIADO;
    :Validar Datos Pedido;
    note right: **Tiempo l√≠mite**: 500ms validaci√≥n
    if (Validaci√≥n correcta?) then (s√≠)
        :Crear Pedido PENDIENTE;
        note right: **Estado**: Inmutable
    else (no)
        :Rechazar Pedido;
        :Emitir Evento SAGA_RECHAZADO;
        :Mostrar Error Validaci√≥n;
        stop
    endif
}

partition "Servicio de Inventario" {
    :Consultar Stock;
    note right: **Cach√© Redis**: >95% aciertos\n**Consulta**: <100ms PostgreSQL
    if (Stock Disponible?) then (s√≠)
        :Reservar Inventario;
        note right: **Bloqueo**: 5s tiempo l√≠mite
        :Emitir Evento INVENTARIO_RESERVADO;
        note right: **SQS**: Entrega garantizada
    else (no)
        :Emitir Evento INVENTARIO_NO_DISPONIBLE;
        :Abortar SAGA;
        partition "Servicio de Pedidos\n(Coordinador SAGA)" {
            :Actualizar Estado CANCELADO;
            :Emitir Evento SAGA_ABORTADO;
        }
        partition "Aplicaci√≥n M√≥vil" {
            :Mostrar Error Stock;
            stop
        }
    endif
}

partition "Servicio de Log√≠stica" {
    :Programar Entrega;
    note right: **Optimizaci√≥n rutas**: Algoritmo entrega\n**Tiempo l√≠mite**: 3s c√°lculo
    if (Entrega Programada?) then (s√≠)
        :Confirmar Programaci√≥n;
        note right: **Geolocalizaci√≥n**: Validaci√≥n GPS (Mock)
        :Emitir Evento ENTREGA_PROGRAMADA;
        note right: **SNS**: Notificaciones push
    else (no)
        :Emitir Evento ENTREGA_FALLIDA;
        partition "Servicio de Pedidos\n(Coordinador SAGA)" {
            :Iniciar Compensaci√≥n SAGA;
            note right: **Reversi√≥n**: <1s rollback
        }
        partition "Servicio de Inventario" {
            :Compensar: Liberar Inventario;
            note right: **Liberaci√≥n**: INVENTARIO_LIBERADO
            :Emitir Evento INVENTARIO_LIBERADO;
        }
        partition "Servicio de Pedidos\n(Coordinador SAGA)" {
            :Cancelar Pedido;
            :Emitir Evento SAGA_COMPENSADO;
        }
        partition "Aplicaci√≥n M√≥vil" {
            :Mostrar Error Entrega;
            stop
        }
    endif
}

partition "Servicio de Pedidos\n(Coordinador SAGA)" {
    :Actualizar Estado CONFIRMADO;
    note right: **ACID**: Transacci√≥n PostgreSQL
    :Emitir Evento SAGA_COMPLETADO;
    note right: **Trazabilidad**: Registro inmutable
}

partition "Aplicaci√≥n M√≥vil" {
    :Mostrar Confirmaci√≥n;
    note right: **Actualizaci√≥n interfaz**: Estado pedido
    end
}

floating note left: **DECISI√ìN ARQUITECT√ìNICA: Patr√≥n SAGA Simplificado**\n\n**‚úÖ Coordinaci√≥n Distribuida MVP:**\n‚Ä¢ **Inventario**: Consulta tiempo real <2s (HU-MOV-005/008)\n‚Ä¢ **Pedidos**: Estados Pendiente‚ÜíProcesando‚ÜíEnviado‚ÜíEntregado (HU-MOV-009)\n‚Ä¢ **Entregas**: Programaci√≥n y seguimiento GPS (HU-MOV-010)\n‚Ä¢ **Compensaci√≥n**: Liberaci√≥n autom√°tica de inventario\n\n**M√âTRICAS DE CALIDAD MVP:**\n‚Ä¢ Latencia consultas: <1s (99.5%)\n‚Ä¢ Latencia operaciones: <3s (99.5%)\n‚Ä¢ Disponibilidad: ‚â•99.95% horario comercial\n‚Ä¢ Capacidad: 100 pedidos/min sostenidos\n‚Ä¢ Compensaci√≥n: <1s reversi√≥n inventario

' ===== CONVENCIONES UML =====
legend bottom
**CONVENCIONES**

**Elementos:**
‚ö´ start/end - Inicio y fin del flujo
‚¨õ Actividad - Acci√≥n o proceso
‚óÜ Condici√≥n - Punto de decisi√≥n
üü¶ Partici√≥n - Agrupaci√≥n por responsabilidad
<back:yellow><color:black><b> Nota </b></color></back> - Anotaciones t√©cnicas

end legend

@enduml
